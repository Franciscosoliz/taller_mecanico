name: Deploy Django to VPS

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to VPS
      env:
        VPS_HOST: ${{ secrets.VPS_HOST }}
        VPS_USER: ${{ secrets.VPS_USERNAME }}
        # RUTA EXACTA AL MANAGE.PY EN TU SERVIDOR
        PROJECT_PATH: /home/Francisco/taller_mecanico_api/taller_mecanico/taller_mecanico_api
        VENV_PATH: /home/Francisco/venv
      run: |
        ssh $VPS_USER@$VPS_HOST "
          set -e
          echo '1. Entrando al directorio del proyecto...'
          cd $PROJECT_PATH

          echo '2. Actualizando código desde GitHub...'
          git fetch origin main
          git reset --hard origin/main

          echo '3. Activando entorno virtual e instalando dependencias...'
          source $VENV_PATH/bin/activate
          # Instalamos usando la ruta donde esté el requirements.txt
          pip install -r requirements.txt

          echo '4. Aplicando migraciones y estáticos...'
          python manage.py migrate --noinput
          python manage.py collectstatic --noinput --clear

          echo '5. Reiniciando el servicio taller_api...'
          sudo systemctl restart taller_api

          echo '✅ ¡Despliegue automático exitoso!'
        "
